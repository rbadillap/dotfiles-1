#!/bin/bash

if [ "$VAGRANT_DIR" == "" ]; then
  echo "Please set VAGRANT_DIR environment variable and run again."
  exit 0
fi

mkdir -p "$VAGRANT_DIR"
cd "$VAGRANT_DIR"

[ -f "Vagrantfile" ]
EXISTS=$?

if [ "$EXISTS" == 0 ]; then
  echo "It seems that a Vagrantfile already exists in this directory."
  read -p "Do you want a fresh install? [Y/n] " -n 1 -r
  echo

  if [[ "$REPLY" =~ ^[Yy]$ ]]; then
    EXISTS=1
    echo "Install fresh environment..."

    vagrant destroy -f
    rm -rf *
    rm -rf .*
  fi
fi

if [ "$EXISTS" == 0 ]; then
  echo "Start provision Vagrantfile..."
  vagrant provision
else
  echo "Install fresh varant environment..."

  ln -sf "$HOME/dotfiles/vagrant/Vagrantfile" "$VAGRANT_DIR/Vagrantfile"
  vagrant box update
  vagrant plugin install vagrant-proxyconf
  vagrant up
fi
