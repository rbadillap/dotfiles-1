HOST           = RbConfig::CONFIG["host_os"]
HOME           = ENV["home"]
VAGRANT_CONFIG = ENV["vagrant_config"]
API_VERSION    = "2"

Vagrant.configure(API_VERSION) do |config|
  config.vm.box = "ubuntu/trusty64"

  config.vm.network :forwarded_port, guest: 8080, host: 30000
  config.ssh.insert_key = false

  # configure proxy if necassary
  if Vagrant.has_plugin?("vagrant-proxyconf")
    if ENV["http_proxy"]
      config.proxy.http = ENV["http_proxy"]
    end
    if ENV["https_proxy"]
      config.proxy.https = ENV["https_proxy"]
    end
    if ENV["no_proxy"]
      config.proxy.no_proxy = ENV["no_proxy"]
    end
  end

  # give vm 1/4 system memory
  config.vm.provider "virtualbox" do |v|
    if HOST =~ /darwin/
      mem = `sysctl -n hw.memsize`.to_i / 1024
    elsif HOST =~ /linux/
      mem = `grep 'MemTotal' /proc/meminfo | sed -e 's/MemTotal://' -e 's/ kb//'`.to_i
    elsif HOST =~ /mswin|mingw|cygwin/
      mem = `wmic computersystem Get TotalPhysicalMemory`.split[1].to_i / 1024
    end

    mem = mem / 1024 / 4
    v.customize ["modifyvm", :id, "--memory", mem]
  end

  if HOST =~ /mswin|mingw|cygwin/
    # synced folders
    config.vm.synced_folder "#{HOME}\\dotfiles", "/home/vagrant/dotfiles"
    config.vm.synced_folder "#{HOME}\\svn",      "/home/vagrant/svn"
    config.vm.synced_folder "#{HOME}\\github",   "/home/vagrant/github"
    config.vm.synced_folder "#{HOME}\\tomcat",   "/home/vagrant/tomcat"

    # provision scripts
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}\\scripts\\base.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}\\scripts\\git.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}\\scripts\\shell.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}\\scripts\\node.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}\\scripts\\vim.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}\\scripts\\tmux.sh"
  else
    # synced folders
    config.vm.synced_folder "#{HOME}/dotfiles", "/home/vagrant/dotfiles"
    config.vm.synced_folder "#{HOME}/dropbox",  "/home/vagrant/dropbox"
    config.vm.synced_folder "github",           "/home/vagrant/github",  create: true

    # provision scripts
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}/scripts/base.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}/scripts/git.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}/scripts/shell.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}/scripts/node.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}/scripts/vim.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}/scripts/tmux.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}/scripts/tensorflow.sh"
    config.vm.provision :shell, privileged: false, :path => "#{VAGRANT_CONFIG}/scripts/latex.sh"
  end

end
